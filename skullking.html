<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ScoreBoard V7</title>
   
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="theme-color" content="#121212">

    <style>
        /* --- DESIGN GLOBAL --- */
        :root {
            --bg: #121212; --surface: #1e1e1e; --text: #ffffff;
            --primary: #8e24aa; /* Skull King */
            --secondary: #d32f2f; /* Papayoo */
            --tertiary: #00acc1; /* Tarot (Cyan) */
            --success: #43a047; --error: #e53935; --disabled: #444;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg); color: var(--text);
            margin: 0; padding: 15px; padding-bottom: 120px;
            -webkit-tap-highlight-color: transparent;
        }

        h1, h2, h3 { text-align: center; margin: 10px 0; }
        .hidden { display: none !important; }

        /* BOUTONS */
        .btn {
            border: none; padding: 15px; border-radius: 12px; font-size: 1.1rem;
            font-weight: bold; width: 100%; cursor: pointer; color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3); margin-bottom: 10px; transition: 0.2s;
        }
        .btn:disabled { background: var(--disabled) !important; opacity: 0.5; }
       
        .btn-sk { background: linear-gradient(45deg, #6a1b9a, #8e24aa); }
        .btn-pap { background: linear-gradient(45deg, #c62828, #d32f2f); }
        .btn-tarot { background: linear-gradient(45deg, #00838f, #00acc1); }
        .btn-neutral { background: #444; }
       
        .btn-row { display: flex; gap: 10px; }

        input, select {
            padding: 15px; border-radius: 10px; border: 1px solid #444;
            background: #2c2c2c; color: white; font-size: 1.1rem; width: 100%;
            box-sizing: border-box; margin-bottom: 10px;
        }

        /* --- MENU --- */
        .game-card {
            background: var(--surface); padding: 20px; border-radius: 15px;
            margin-bottom: 20px; text-align: center; border: 1px solid #333;
        }
        .game-icon { font-size: 3rem; display: block; margin-bottom: 10px; }

        /* --- UI JOUEUR --- */
        .player-card {
            background-color: var(--surface); padding: 15px; margin-bottom: 15px;
            border-radius: 12px; border-left: 5px solid #555;
        }
        .player-header {
            display: flex; justify-content: space-between; font-weight: bold;
            font-size: 1.2rem; margin-bottom: 5px; border-bottom: 1px solid #333; padding-bottom: 8px;
        }

        /* --- TAROT SPECIFIC --- */
        .tarot-board {
            display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;
            margin-bottom: 20px; background: #263238; padding: 10px; border-radius: 10px;
        }
        .tarot-score-pill {
            background: #37474f; padding: 8px 12px; border-radius: 20px;
            font-size: 0.9rem; border: 1px solid var(--tertiary); min-width: 80px; text-align: center;
        }
        .tarot-score-val { font-weight: bold; font-size: 1.1rem; display: block; }
       
        .tarot-form label { display: block; color: #aaa; margin-bottom: 5px; font-size: 0.9rem; }
        .tarot-segment { display: flex; gap: 5px; margin-bottom: 15px; overflow-x: auto; }
        .segment-btn {
            flex: 1; background: #333; border: 1px solid #555; padding: 10px; color: #aaa;
            border-radius: 8px; cursor: pointer; white-space: nowrap;
        }
        .segment-btn.selected { background: var(--tertiary); color: white; border-color: var(--tertiary); font-weight: bold; }

        /* --- SKULL KING & PAPAYOO SPECIFIC --- */
        .sk-control-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .sk-stepper { display: flex; align-items: center; background: #2b2b2b; border-radius: 20px; }
        .sk-btn-step { width: 44px; height: 44px; background: #3d3d3d; border: none; color: white; font-size: 1.3rem; border-radius: 50%; touch-action: manipulation; }
        .sk-val { width: 35px; text-align: center; font-weight: bold; font-size: 1.1rem; }

        .pap-input-row { display: flex; align-items: center; gap: 10px; }
        .pap-input { width: 80px; text-align: center; font-weight: bold; font-size: 1.3rem; }
        .btn-magic { background: none; border: 1px solid #444; color: #ffd700; border-radius: 8px; padding: 10px; font-size: 1.2rem; }

        /* FLOATING ACTION */
        .floating-action {
            position: fixed; bottom: 0; left: 0; right: 0; padding: 15px;
            background: linear-gradient(to top, var(--bg) 90%, transparent); z-index: 100;
        }
        .total-banner {
            position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%);
            background: #111; padding: 10px 25px; border-radius: 30px;
            font-weight: bold; font-size: 1.1rem; border: 2px solid #333; z-index: 99; white-space: nowrap;
        }
        .sum-ok { color: var(--success); border-color: var(--success); }
        .sum-bad { color: var(--error); border-color: var(--error); }

        /* TABLEAU RESULTATS */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        td { padding: 12px; border-bottom: 1px solid #333; }
        .rank-1 { color: #ffd700; font-weight: bold; }
    </style>
</head>
<body>

    <div id="screen-menu">
        <h1>Mes Jeux</h1>
       
        <div class="game-card" onclick="goToSetup('skullking')">
            <span class="game-icon">üíÄ</span>
            <h2>Skull King</h2>
            <button class="btn btn-sk">Jouer</button>
        </div>

        <div class="game-card" onclick="goToSetup('papayoo')">
            <span class="game-icon">üé≤</span>
            <h2>Papayoo</h2>
            <button class="btn btn-pap">Jouer</button>
        </div>

        <div class="game-card" onclick="goToSetup('tarot')">
            <span class="game-icon">üîÆ</span>
            <h2>Tarot</h2>
            <button class="btn btn-tarot">Jouer</button>
        </div>
    </div>

    <div id="screen-setup" class="hidden">
        <h1 id="setup-title">Configuration</h1>
        <p style="text-align:center; color:#aaa;">Joueurs (virgule)</p>
        <input type="text" id="input-players" placeholder="Ex: Alex, Julie, Marc..." onkeyup="updateSetupInfo()" />
       
        <div id="setup-info" class="hidden" style="background:#263238; padding:15px; border-radius:8px; margin-bottom:15px; font-size:0.9rem;"></div>

        <button id="btn-start" class="btn" onclick="startGame()">Lancer la partie</button>
        <button class="btn btn-neutral" onclick="location.reload()">Retour</button>
    </div>

    <div id="screen-game" class="hidden">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <button onclick="if(confirm('Quitter ?')) location.reload()" style="background:none; border:none; font-size:1.5rem;">üè†</button>
            <h3 style="margin:0;"><span id="game-name">Jeu</span> <span id="round-num" style="font-size:0.8rem; color:#aaa;">(M1)</span></h3>
            <span style="width:30px;"></span>
        </div>

        <div id="dealer-banner" class="hidden" style="text-align:center; background:#333; padding:5px; border-radius:15px; margin-bottom:10px; font-size:0.9rem;">
            üÉè Donneur : <strong id="dealer-name"></strong>
        </div>

        <div id="game-container" style="padding-bottom: 80px;"></div>

        <div id="game-total-banner" class="total-banner hidden"><span id="banner-text">Total</span></div>

        <div class="floating-action">
            <div id="action-btn-container"></div>
        </div>
    </div>

    <div id="screen-results" class="hidden">
        <h1>üèÜ R√©sultats Finaux</h1>
        <table id="results-table"><tbody id="results-body"></tbody></table>
        <br><button class="btn btn-neutral" onclick="location.reload()">Menu</button>
    </div>

    <script>
        // --- DATA & STATE ---
        let state = { game: null, players: [], round: 1, dealerIdx: 0, maxRounds: 10 };
       
        // CONFIG R√àGLES
        const RULES = {
            papayoo: {
                3: "6x3 + 1x2 cartes (√âcart 5)", 4: "5x3 cartes (√âcart 5)", 5: "4x3 cartes (√âcart 4)",
                6: "3x3 + 1x2 cartes (√âcart 3)", 7: "‚ö†Ô∏è Sans les As ! (√âcart 3)", 8: "‚ö†Ô∏è Sans les As ! (√âcart 3)"
            },
            tarot: {
                3: "3 joueurs : Le preneur joue contre 2.",
                4: "4 joueurs : Le preneur joue contre 3.",
                5: "5 joueurs : Appel au Roi (Preneur + Partenaire vs 3)."
            }
        };

        const TAROT_OUDLERS = { 0: 56, 1: 51, 2: 41, 3: 36 };
        const TAROT_CONTRATS = { 'P': 1, 'G': 2, 'GS': 4, 'GC': 6 }; // Multiplicateurs

        // --- NAVIGATION ---
        function goToSetup(type) {
            state.game = type; state.round = 1; state.dealerIdx = 0;
            const title = document.getElementById('setup-title');
            const btn = document.getElementById('btn-start');
            const info = document.getElementById('setup-info');
           
            info.classList.add('hidden'); // Reset
           
            if (type === 'skullking') {
                title.innerText = "üíÄ Skull King"; btn.className = "btn btn-sk"; state.maxRounds = 10;
            } else if (type === 'papayoo') {
                title.innerText = "üé≤ Papayoo"; btn.className = "btn btn-pap"; state.maxRounds = 999;
                updateSetupInfo();
            } else if (type === 'tarot') {
                title.innerText = "üîÆ Tarot"; btn.className = "btn btn-tarot"; state.maxRounds = 999;
                updateSetupInfo();
            }
           
            document.querySelectorAll('body > div').forEach(d => d.classList.add('hidden'));
            document.getElementById('screen-setup').classList.remove('hidden');
        }

        function updateSetupInfo() {
            const nb = document.getElementById('input-players').value.split(',').filter(n=>n.trim()).length;
            const info = document.getElementById('setup-info');
           
            if (state.game === 'papayoo' && nb >= 3 && nb <= 8) {
                info.classList.remove('hidden'); info.innerText = RULES.papayoo[nb];
            } else if (state.game === 'tarot' && nb >= 3 && nb <= 5) {
                info.classList.remove('hidden'); info.innerText = RULES.tarot[nb];
            } else {
                info.classList.add('hidden');
            }
        }

        function startGame() {
            const names = document.getElementById('input-players').value.split(',').map(n=>n.trim()).filter(n=>n);
            if (!names.length) return;
           
            // Init Players Object
            state.players = names.map(n => ({
                name: n, score: 0,
                // SK vars
                bet:0, made:0, bonusSir:0, bonusPir:0, bonusSK:0, bonus14Std:0, bonus14Black:0,
            }));

            document.getElementById('screen-setup').classList.add('hidden');
            document.getElementById('screen-game').classList.remove('hidden');
            renderGameUI();
        }

        // --- RENDER UI (MAIN ROUTER) ---
        function renderGameUI() {
            // Header Infos
            const gName = state.game === 'skullking' ? "Skull King" : (state.game === 'papayoo' ? "Papayoo" : "Tarot");
            document.getElementById('game-name').innerText = gName;
            document.getElementById('round-num').innerText = `(M${state.round})`;
           
            // Dealer Banner
            if(state.players.length > 0) {
                document.getElementById('dealer-banner').classList.remove('hidden');
                document.getElementById('dealer-name').innerText = state.players[state.dealerIdx].name;
            }

            const container = document.getElementById('game-container');
            container.innerHTML = '';
           
            // Reset Banner
            document.getElementById('game-total-banner').classList.add('hidden');

            // --- 1. SKULL KING UI ---
            if (state.game === 'skullking') {
                state.players.forEach((p, i) => container.innerHTML += getSkullKingCard(p, i));
                checkSkullKingTotal();
                setActions(`<button id="btn-sk-next" class="btn btn-sk" onclick="nextRound()" disabled>${state.round===10?'üèÅ Fin':'Manche Suivante'}</button>`);
            }
            // --- 2. PAPAYOO UI ---
            else if (state.game === 'papayoo') {
                state.players.forEach((p, i) => container.innerHTML += getPapayooCard(p, i));
                checkPapayooSum();
                setActions(`
                    <div class="btn-row">
                        <button class="btn btn-neutral" onclick="finishGame()">Finir</button>
                        <button id="btn-pap-next" class="btn btn-pap" onclick="nextRound()" disabled>Suivante ></button>
                    </div>`);
            }
            // --- 3. TAROT UI (NEW) ---
            else if (state.game === 'tarot') {
                container.innerHTML = getTarotUI();
                setActions(`
                    <div class="btn-row">
                        <button class="btn btn-neutral" onclick="finishGame()">Finir</button>
                        <button class="btn btn-tarot" onclick="validateTarotRound()">Valider Manche</button>
                    </div>`);
            }
        }

        function setActions(html) { document.getElementById('action-btn-container').innerHTML = html; }

        // --- HTML GENERATORS ---
       
        // TAROT GENERATOR
        function getTarotUI() {
            // 1. Scoreboard Top
            let scoresHtml = '<div class="tarot-board">';
            state.players.forEach(p => {
                scoresHtml += `<div class="tarot-score-pill"><span>${p.name}</span><span class="tarot-score-val">${p.score}</span></div>`;
            });
            scoresHtml += '</div>';

            // 2. Input Form
            // Preneur select
            let options = state.players.map((p,i) => `<option value="${i}">${p.name}</option>`).join('');
           
            // Partenaire select (only if 5 players)
            let partnerHtml = '';
            if (state.players.length === 5) {
                partnerHtml = `<label>Appel au Roi (Partenaire)</label><select id="t-partner"><option value="-1">Aucun (Joue seul)</option>${options}</select>`;
            }

            return `
            ${scoresHtml}
            <div class="player-card tarot-form" style="border-left-color: var(--tertiary)">
                <label>Preneur</label>
                <select id="t-taker">${options}</select>
               
                ${partnerHtml}

                <label>Contrat</label>
                <div class="tarot-segment">
                    <button class="segment-btn selected" onclick="selectSeg(this, 'P')" id="seg-P">Petite</button>
                    <button class="segment-btn" onclick="selectSeg(this, 'G')">Garde</button>
                    <button class="segment-btn" onclick="selectSeg(this, 'GS')">G.Sans</button>
                    <button class="segment-btn" onclick="selectSeg(this, 'GC')">G.Contre</button>
                </div>
                <input type="hidden" id="t-contract" value="P">

                <div style="display:flex; gap:10px;">
                    <div style="flex:1">
                        <label>Bouts (Oudlers)</label>
                        <select id="t-oudlers">
                            <option value="0">0 (56)</option>
                            <option value="1">1 (51)</option>
                            <option value="2">2 (41)</option>
                            <option value="3">3 (36)</option>
                        </select>
                    </div>
                    <div style="flex:1">
                        <label>Points Faits</label>
                        <input type="number" id="t-points" placeholder="Ex: 45">
                    </div>
                </div>

                <label>Petit au Bout</label>
                <select id="t-petit">
                    <option value="0">Non</option>
                    <option value="1">Oui - Pour l'Attaque (+)</option>
                    <option value="-1">Oui - Pour la D√©fense (-)</option>
                </select>
            </div>
            `;
        }

        // --- TAROT LOGIC ---
        function selectSeg(btn, val) {
            document.querySelectorAll('.segment-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            document.getElementById('t-contract').value = val;
        }

        function validateTarotRound() {
            const takerIdx = parseInt(document.getElementById('t-taker').value);
            const partnerIdx = document.getElementById('t-partner') ? parseInt(document.getElementById('t-partner').value) : -1;
            const contract = document.getElementById('t-contract').value;
            const nbOudlers = parseInt(document.getElementById('t-oudlers').value);
            const pointsMade = parseFloat(document.getElementById('t-points').value); // Float pour les demi-points
            const petitStatus = parseInt(document.getElementById('t-petit').value);

            if (isNaN(pointsMade)) return alert("Entrez les points faits !");
            if (state.players.length === 5 && takerIdx === partnerIdx) return alert("Le preneur ne peut pas √™tre son propre partenaire (sauf s'il joue seul, choisissez 'Aucun').");

            // 1. Calcul de base
            const target = TAROT_OUDLERS[nbOudlers];
            const diff = pointsMade - target;
            const isSuccess = diff >= 0;
           
            // 2. Calcul des points de l'√©change
            // Formule : (25 + Abs(Ecart) + Petit) * Multiplicateur
            const petitBonus = (petitStatus !== 0) ? 10 : 0;
           
            // Note: Si le petit est pour la d√©fense mais que l'attaque gagne, on soustrait le petit du total ?
            // Simplification standard : Le bonus petit suit le camp qui l'a men√© au bout, multipli√© par le contrat.
            // Si l'attaque le m√®ne au bout, elle gagne (25 + Ecart + 10) * Mult.
            // Si la d√©fense le m√®ne au bout, l'attaque gagne (25 + Ecart - 10) * Mult ??
            // -> Standard FFtarot : Le camp qui a le petit b√©n√©ficie du bonus.
           
            let baseScore = 25 + Math.abs(diff);
           
            // Gestion Petit au bout : S'ajoute ou se retranche au calcul AVANT multiplication
            // Si Petit pour Attaque : +10. Si Petit pour D√©fense : -10. (Du point de vue du contrat)
            // Mais attention, si le contrat chute, la logique s'inverse.
            // M√©thode simple : Calculer la valeur brute du petit (10 * Mult) et l'ajouter au solde global.
           
            let scoreExchange = baseScore * TAROT_CONTRATS[contract];

            // Ajustement Petit (Multipli√©)
            if (petitStatus === 1) scoreExchange += (10 * TAROT_CONTRATS[contract]); // Bonus pour attaque
            if (petitStatus === -1) scoreExchange -= (10 * TAROT_CONTRATS[contract]); // Malus pour attaque (Bonus d√©fense)

            // Si le contrat est chut√©, le score est n√©gatif pour l'attaque
            if (!isSuccess) scoreExchange = -scoreExchange;

            // 3. Distribution aux joueurs
            const nbPlayers = state.players.length;

            if (nbPlayers === 3 || nbPlayers === 4) {
                // Preneur vs D√©fenseurs
                const defendersCount = nbPlayers - 1;
                const pointsPerDefender = -scoreExchange;
                const pointsTaker = scoreExchange * defendersCount;

                state.players.forEach((p, i) => {
                    if (i === takerIdx) p.score += pointsTaker;
                    else p.score += pointsPerDefender;
                });

            } else if (nbPlayers === 5) {
                if (partnerIdx === -1 || partnerIdx === takerIdx) {
                    // Joue seul √† 5 (Preneur vs 4)
                    const pointsTaker = scoreExchange * 4;
                    const pointsDef = -scoreExchange;
                    state.players.forEach((p, i) => {
                        if (i === takerIdx) p.score += pointsTaker;
                        else p.score += pointsDef;
                    });
                } else {
                    // Appel au Roi (2 vs 3)
                    // R√©partition standard : Taker (2/3 gains), Partner (1/3 gains), Defense (-1 gain chacun)
                    // Donc : Preneur +2*S, Partenaire +1*S, 3 D√©fenseurs -1*S.
                    const pointsTaker = scoreExchange * 2;
                    const pointsPartner = scoreExchange;
                    const pointsDef = -scoreExchange;

                    state.players.forEach((p, i) => {
                        if (i === takerIdx) p.score += pointsTaker;
                        else if (i === partnerIdx) p.score += pointsPartner;
                        else p.score += pointsDef;
                    });
                }
            }

            // Fin de manche
            nextRound(true); // true = skip standard calculation
        }

        // --- HELPERS AUTRES JEUX ---
        function getPapayooCard(p, i) {
            return `<div class="player-card" style="border-left-color: var(--secondary)"><div class="player-header"><span>${p.name}</span><span>Total: ${p.score}</span></div><div class="pap-input-row"><input type="number" class="pap-input" id="pap-in-${i}" placeholder="0" oninput="checkPapayooSum()"><button class="btn-magic" onclick="fillRemainder(${i})">ü™Ñ</button></div></div>`;
        }
        function getSkullKingCard(p, i) {
            return `<div class="player-card" style="border-left-color: var(--primary)"><div class="player-header"><span>${p.name}</span><span>${p.score} pts</span></div><div class="sk-control-row"><span style="color:#aaa">Pari</span><div class="sk-stepper"><button class="sk-btn-step" onclick="updSk(${i},'bet',-1)">-</button><span class="sk-val" id="sk-bet-${i}">${p.bet}</span><button class="sk-btn-step" onclick="updSk(${i},'bet',1)">+</button></div></div><div class="sk-control-row"><span style="color:#aaa">Plis Faits</span><div class="sk-stepper"><button class="sk-btn-step" onclick="updSk(${i},'made',-1)">-</button><span class="sk-val" id="sk-made-${i}">${p.made}</span><button class="sk-btn-step" onclick="updSk(${i},'made',1)">+</button></div></div><button onclick="document.getElementById('bonus-${i}').classList.toggle('hidden')" style="background:none; border:1px dashed #555; color:#aaa; width:100%; padding:5px; margin-top:5px;">Bonus üîΩ</button><div id="bonus-${i}" class="hidden" style="background:#252525; padding:5px; margin-top:5px;">${getSkBonus(i,'Sir√®ne (20)','bonusSir',p.bonusSir)}${getSkBonus(i,'Pirate (30)','bonusPir',p.bonusPir)}${getSkBonus(i,'King (50)','bonusSK',p.bonusSK)}${getSkBonus(i,'14 (10)','bonus14Std',p.bonus14Std)}${getSkBonus(i,'14 Noir (20)','bonus14Black',p.bonus14Black)}</div></div>`;
        }
        function getSkBonus(i,l,f,v) { return `<div class="sk-control-row" style="font-size:0.9rem"><span>${l}</span><div class="sk-stepper" style="transform:scale(0.9)"><button class="sk-btn-step" onclick="updSk(${i},'${f}',-1)">-</button><span class="sk-val" id="sk-${f}-${i}">${v}</span><button class="sk-btn-step" onclick="updSk(${i},'${f}',1)">+</button></div></div>`; }

        // --- UPDATES ---
        function checkPapayooSum() {
            let sum = 0; state.players.forEach((p, i) => sum += (parseInt(document.getElementById(`pap-in-${i}`).value) || 0));
            const banner = document.getElementById('game-total-banner');
            banner.classList.remove('hidden'); document.getElementById('banner-text').innerText = `Total : ${sum} / 250`;
            const btn = document.getElementById('btn-pap-next');
            if (sum === 250) { banner.className = "total-banner sum-ok"; btn.disabled = false; } else { banner.className = "total-banner sum-bad"; btn.disabled = true; }
        }
        function fillRemainder(idx) {
            let cur = 0; state.players.forEach((p,i) => { if(i!==idx) cur += (parseInt(document.getElementById(`pap-in-${i}`).value)||0) });
            document.getElementById(`pap-in-${idx}`).value = 250 - cur; checkPapayooSum();
        }
        function checkSkullKingTotal() {
            let total = 0; state.players.forEach(p => total += p.made);
            const banner = document.getElementById('game-total-banner');
            banner.classList.remove('hidden'); document.getElementById('banner-text').innerText = `Plis : ${total} / ${state.round}`;
            const btn = document.getElementById('btn-sk-next');
            if (total === state.round) { banner.className = "total-banner sum-ok"; btn.disabled = false; } else { banner.className = "total-banner sum-bad"; btn.disabled = true; }
        }
        function updSk(i, fld, d) {
            const p = state.players[i]; let nv = p[fld] + d;
            if(nv < 0) return;
            if((fld==='bet'||fld==='made') && nv > state.round) return;
            if((fld==='bonusSK'||fld==='bonus14Black') && nv > 1) return;
            p[fld] = nv; document.getElementById(`sk-${fld}-${i}`).innerText = nv;
            if (fld === 'made') checkSkullKingTotal();
        }

        // --- GLOBAL NEXT ROUND ---
        function nextRound(skipCalc = false) {
            if (!skipCalc) {
                if (state.game === 'skullking') {
                    state.players.forEach(p => {
                        let pts = 0;
                        if(p.bet===0) pts = (p.made===0)?(state.round*10):(state.round*-10);
                        else { if(p.bet===p.made) pts = (p.bet*20)+(p.bonusSir*20)+(p.bonusPir*30)+(p.bonusSK*50)+(p.bonus14Std*10)+(p.bonus14Black*20); else pts = Math.abs(p.bet-p.made)*-10; }
                        p.score += pts; p.bet=0; p.made=0; p.bonusSir=0; p.bonusPir=0; p.bonusSK=0; p.bonus14Std=0; p.bonus14Black=0;
                    });
                    if (state.round >= 10) return finishGame();
                } else if (state.game === 'papayoo') {
                    state.players.forEach((p, i) => p.score += (parseInt(document.getElementById(`pap-in-${i}`).value) || 0));
                }
            }
            // Advance
            state.round++;
            state.dealerIdx = (state.dealerIdx + 1) % state.players.length;
            renderGameUI();
            window.scrollTo(0,0);
        }

        function finishGame() {
            document.getElementById('screen-game').classList.add('hidden');
            document.getElementById('screen-results').classList.remove('hidden');
            const tbody = document.getElementById('results-body'); tbody.innerHTML = '';
           
            // Sort: Desc for SK/Tarot, Asc for Papayoo
            const desc = (state.game !== 'papayoo');
            state.players.sort((a,b) => desc ? b.score-a.score : a.score-b.score);
           
            state.players.forEach((p, i) => tbody.innerHTML += `<tr><td class="${i===0?'rank-1':''}">${i===0?'üèÜ ':''}${p.name}</td><td style="text-align:right;font-weight:bold;">${p.score}</td></tr>`);
        }
    </script>
    <script>
        if ('serviceWorker' in navigator) { navigator.serviceWorker.register('./sw.js').catch(console.log); }
    </script>
</body>
</html>